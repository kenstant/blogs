<!DOCTYPE html>
<html lang="zh-CN" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>积分消费日志表数据迁移 | kenstant的博客</title>
    <meta name="description" content="kenstant的博客">
    <meta name="generator" content="VitePress v2.0.0-alpha.16">
    <link rel="preload stylesheet" href="/blogs/assets/style.B4PWJrCz.css" as="style">
    <link rel="preload stylesheet" href="/blogs/vp-icons.css" as="style">
    
    <script type="module" src="/blogs/assets/app.CM0tDhzG.js"></script>
    <link rel="preload" href="/blogs/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/blogs/assets/chunks/theme.DJQ3o67N.js">
    <link rel="modulepreload" href="/blogs/assets/chunks/framework.6-m_a-od.js">
    <link rel="modulepreload" href="/blogs/assets/tech-learning_practice_积分消费日志表数据迁移.md.ZV_VSquq.lean.js">
    <link rel="icon" href="/blogs/icons/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="/blogs/icons/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/blogs/icons/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/blogs/icons/apple-touch-icon.png">
    <link rel="manifest" href="/blogs/icons/site.webmanifest">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-8e410b79><!--[--><!--]--><!--[--><span tabindex="-1" data-v-be48d319></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-be48d319>Skip to content</a><!--]--><!----><header class="VPNav" data-v-8e410b79 data-v-46d25293><div class="VPNavBar top" data-v-46d25293 data-v-ddefa081><div class="wrapper" data-v-ddefa081><div class="container" data-v-ddefa081><div class="title" data-v-ddefa081><div class="VPNavBarTitle" data-v-ddefa081 data-v-4218a31a><a class="title" href="/blogs/" data-v-4218a31a><!--[--><!--]--><!----><span data-v-4218a31a>kenstant的博客</span><!--[--><!--]--></a></div></div><div class="content" data-v-ddefa081><div class="content-body" data-v-ddefa081><!--[--><!--]--><div class="VPNavBarSearch search" data-v-ddefa081 data-v-c6b1e06a><!--[--><button type="button" class="VPNavBarSearchButton" aria-label="Search" aria-keyshortcuts="/ control+k meta+k" data-v-c6b1e06a data-v-ef676460><span class="vpi-search" aria-hidden="true" data-v-ef676460></span><span class="text" data-v-ef676460>Search</span><span class="keys" aria-hidden="true" data-v-ef676460><kbd class="key-cmd" data-v-ef676460>⌘</kbd><kbd class="key-ctrl" data-v-ef676460>Ctrl</kbd><kbd data-v-ef676460>K</kbd></span></button><!----><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-ddefa081 data-v-b5c5c4dc><span id="main-nav-aria-label" class="visually-hidden" data-v-b5c5c4dc> Main Navigation </span><!--[--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-ddefa081 data-v-4c439896><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-4c439896 data-v-e7985c94 data-v-ad1bd3fa><span class="check" data-v-ad1bd3fa><span class="icon" data-v-ad1bd3fa><!--[--><span class="vpi-sun sun" data-v-e7985c94></span><span class="vpi-moon moon" data-v-e7985c94></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-ddefa081 data-v-61ed4e50 data-v-10b1d303><!--[--><a class="VPSocialLink no-icon" href="https://github.com/kenstant" aria-label="github" target="_blank" rel="me noopener" data-v-10b1d303 data-v-22b9c8b5><span class="vpi-social-github"></span></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-ddefa081 data-v-12e31893 data-v-db8b1fc3><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-db8b1fc3><span class="vpi-more-horizontal icon" data-v-db8b1fc3></span></button><div class="menu" data-v-db8b1fc3><div class="VPMenu" data-v-db8b1fc3 data-v-70413b0b><!----><!--[--><!--[--><!----><div class="group" data-v-12e31893><div class="item appearance" data-v-12e31893><p class="label" data-v-12e31893>Appearance</p><div class="appearance-action" data-v-12e31893><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-12e31893 data-v-e7985c94 data-v-ad1bd3fa><span class="check" data-v-ad1bd3fa><span class="icon" data-v-ad1bd3fa><!--[--><span class="vpi-sun sun" data-v-e7985c94></span><span class="vpi-moon moon" data-v-e7985c94></span><!--]--></span></span></button></div></div></div><div class="group" data-v-12e31893><div class="item social-links" data-v-12e31893><div class="VPSocialLinks social-links-list" data-v-12e31893 data-v-10b1d303><!--[--><a class="VPSocialLink no-icon" href="https://github.com/kenstant" aria-label="github" target="_blank" rel="me noopener" data-v-10b1d303 data-v-22b9c8b5><span class="vpi-social-github"></span></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-ddefa081 data-v-0068b816><span class="container" data-v-0068b816><span class="top" data-v-0068b816></span><span class="middle" data-v-0068b816></span><span class="bottom" data-v-0068b816></span></span></button></div></div></div></div><div class="divider" data-v-ddefa081><div class="divider-line" data-v-ddefa081></div></div></div><!----></header><div class="VPLocalNav empty fixed" data-v-8e410b79 data-v-ce6f96dc><div class="container" data-v-ce6f96dc><!----><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-ce6f96dc data-v-9b0a0265><button data-v-9b0a0265>返回顶部</button><!----></div></div></div><!----><div class="VPContent" id="VPContent" data-v-8e410b79 data-v-1321b454><div class="VPDoc has-aside" data-v-1321b454 data-v-d30c2b42><!--[--><!--]--><div class="container" data-v-d30c2b42><div class="aside" data-v-d30c2b42><div class="aside-curtain" data-v-d30c2b42></div><div class="aside-container" data-v-d30c2b42><div class="aside-content" data-v-d30c2b42><div class="VPDocAside" data-v-d30c2b42 data-v-9a6af9f7><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-9a6af9f7 data-v-b72904b0><div class="content" data-v-b72904b0><div class="outline-marker" data-v-b72904b0></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-b72904b0>On this page</div><ul class="VPDocOutlineItem root" data-v-b72904b0 data-v-835de44b><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-9a6af9f7></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-d30c2b42><div class="content-container" data-v-d30c2b42><!--[--><!--]--><main class="main" data-v-d30c2b42><div style="position:relative;" class="vp-doc _blogs_tech-learning_practice_%E7%A7%AF%E5%88%86%E6%B6%88%E8%B4%B9%E6%97%A5%E5%BF%97%E8%A1%A8%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB external-link-icon-enabled" data-v-d30c2b42><div><h1 id="积分消费日志表数据迁移" tabindex="-1">积分消费日志表数据迁移 <a class="header-anchor" href="#积分消费日志表数据迁移" aria-label="Permalink to “积分消费日志表数据迁移”">​</a></h1><h2 id="需求背景" tabindex="-1">需求背景 <a class="header-anchor" href="#需求背景" aria-label="Permalink to “需求背景”">​</a></h2><ol><li>原先积分消费日志表存放在PolarDB中，单表数据已经达到4亿多条，故决定将数据迁移到lindorm中去。</li><li>同时还有一个积分明细的查询需求，所以在同步数据的时候顺便进行数据的清洗整理方便后面业务需求开发。</li><li>数据清洗主要是业务层面的字段添加和修改，根据原有数据进行一些字段的补充和调整，以满足后续业务查询需求。</li></ol><h2 id="表分析" tabindex="-1">表分析 <a class="header-anchor" href="#表分析" aria-label="Permalink to “表分析”">​</a></h2><ol><li>原表是一张积分消费日志的记录表，只会有新增，没有更新和删除操作。</li><li>最开始是从MySQL迁移到PolarDB for MySQL版，所以主键一直是自增id。</li><li>Lindorm是一个分布式的数据库，没有自增id，需要自己设计和生成主键id。</li></ol><h3 id="主键设计" tabindex="-1">主键设计 <a class="header-anchor" href="#主键设计" aria-label="Permalink to “主键设计”">​</a></h3><ol><li><strong>唯一ID生成</strong>：使用雪花算法生成唯一ID，作为业务层面的唯一标识。</li><li><strong>主键设计</strong>：Lindorm的主键是根据几个业务列组合而成，这样设计更符合Lindorm的数据查找特性，能够提高查询效率。</li></ol><h2 id="技术方案" tabindex="-1">技术方案 <a class="header-anchor" href="#技术方案" aria-label="Permalink to “技术方案”">​</a></h2><h3 id="方案一-未采用" tabindex="-1">方案一：（未采用） <a class="header-anchor" href="#方案一-未采用" aria-label="Permalink to “方案一：（未采用）”">​</a></h3><ol><li>将<code>源表</code>数据全量同步到阿里云<code>MaxCompute</code>中（大数据离线计算系统），然后按照业务需求清洗数据，最后写入<code>目标表</code>中去。</li><li>后续利用 mq和定时任务进行历史数据的同步和双写。因为最终没有采用，且做法和<code>方案二</code>方法差不多，故此处不详细描述。</li></ol><p>拒绝原因：</p><ol><li>时间上可能更快，但是最后双写同步阶段清洗数据的代码需要再大数据系统和Java应用层都写一遍，有点重复工作，并且工作量也不小。</li><li>MaxCompute原有资源在其他的项目中占用了，不太能腾出来给我们使用。</li></ol><h3 id="方案二-采用" tabindex="-1">方案二：（采用） <a class="header-anchor" href="#方案二-采用" aria-label="Permalink to “方案二：（采用）”">​</a></h3><ol><li><p><strong>创建同步错误记录表</strong>：创建一张同步错误记录表，专门记录同步出错的<code>源表id及错误信息</code>，方便后续处理。</p></li><li><p><strong>历史数据全量同步</strong>：记录下此时此刻<code>源表</code>中的最大id值，记为<code>a</code>，先将<code>0 &lt; id &lt; a</code>的数据同步到<code>目标表</code>。</p><ul><li>利用单机定时任务按照id分段扫描源表，先检查目标表中是否存在，然后再同步。</li><li>失败的写进失败记录表，同步成功的incr一下<code>redis中的同步成功条数</code>。</li><li>每个分段处理完之后，更新一下redis中的同步进度，以便应用重启时的断点续写处理。</li><li><strong>分段策略演进</strong>： <ul><li>最初采用每段100条，5个线程并发处理，但经过估算发现全部写完需要花费一个月时间。</li><li>优化后改为每段200条，10个线程并发处理，大大提升了同步效率。</li></ul></li></ul></li><li><p><strong>全量同步完成检查</strong>：全部写完后记录下<code>目标表</code>中的最大值id，记为<code>x</code>（x&lt;=a），检查两表条数是否一样。</p></li><li><p><strong>开启双写同步</strong>：利用<code>RocketMQ</code>进行双写同步，记录下双写开始的id最小值，记为<code>y</code>。观察双写阶段的数据条数是否一致，无问题则进行下一步。</p></li><li><p><strong>双写期间历史数据同步</strong>：利用<code>定时任务</code>，将<code>x &lt; id &lt; y</code>的历史数据逐条同步到目标表（同步骤2）。这一步是在双写开启后进行的，确保双写期间产生的数据也能被同步。</p></li><li><p><strong>数据一致性检查</strong>：第5步完成后，检查两表总条数，如果差距不大则进行下一步，如果差距过大，需要检查<code>id &gt; x</code>的数据中是哪里出了问题。</p></li><li><p><strong>切换写入目标</strong>：原来写入<code>源表</code>的地方直接改成写入<code>目标表</code>，但是双写时用到的<code>MQ投递和消费不停</code>，应用全部重启之后，应该就不会再产生新的消息。切完之后，没有问题则去掉MQ的投递和消费。</p></li><li><p><strong>处理错误数据</strong>：处理错误表中的数据。</p></li></ol><h2 id="最终效果" tabindex="-1">最终效果 <a class="header-anchor" href="#最终效果" aria-label="Permalink to “最终效果”">​</a></h2><h3 id="迁移结果" tabindex="-1">迁移结果 <a class="header-anchor" href="#迁移结果" aria-label="Permalink to “迁移结果”">​</a></h3><ul><li><strong>总迁移数据量</strong>：4.5亿条</li><li><strong>错误数据量</strong>：1500多条</li><li><strong>错误率</strong>：约0.0003%，错误率极低</li></ul><h3 id="问题处理" tabindex="-1">问题处理 <a class="header-anchor" href="#问题处理" aria-label="Permalink to “问题处理”">​</a></h3><p>迁移过程中遇到的主要错误类型是 <code>expected 1, but found 2</code> 这种错误，即期望查询到1条数据，但实际查询到了2条数据。这种情况通常是由于数据重复或者查询条件不够精确导致的。</p><p><strong>解决方案</strong>：对于这类错误，采用 <code>limit 1</code> 的方式进行处理，只取第一条数据，确保数据同步的顺利进行。</p><h3 id="经验总结" tabindex="-1">经验总结 <a class="header-anchor" href="#经验总结" aria-label="Permalink to “经验总结”">​</a></h3><ol><li><p><strong>分段策略优化</strong>：通过调整分段大小和并发线程数，可以显著提升迁移效率。从最初的每段100条、5线程，优化到每段200条、10线程，大大缩短了迁移时间。</p></li><li><p><strong>先双写再同步历史数据</strong>：采用先开启双写，再同步双写期间历史数据的策略，可以确保数据不丢失，同时保证迁移过程的平滑进行。</p></li><li><p><strong>错误处理机制</strong>：建立完善的错误记录表，对于迁移过程中的错误数据进行记录和处理，确保最终数据的完整性。</p></li><li><p><strong>主键设计</strong>：根据Lindorm的特性，采用多列组合主键的方式，能够更好地利用Lindorm的查询优势，提升后续查询性能。</p></li></ol></div></div></main><footer class="VPDocFooter" data-v-d30c2b42 data-v-6d6b3e6e><!--[--><!--]--><div class="edit-info" data-v-6d6b3e6e><!----><div class="last-updated" data-v-6d6b3e6e><p class="VPLastUpdated" data-v-6d6b3e6e data-v-17f12ee2>上次更新时间: <time datetime="2025-12-24T07:26:22.000Z" data-v-17f12ee2></time></p></div></div><!----></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><footer class="VPFooter" data-v-8e410b79 data-v-e121ba62><div class="container" data-v-e121ba62><p class="message" data-v-e121ba62>我与我周旋久，宁做我</p><p class="copyright" data-v-e121ba62>Copyright © 2025</p></div></footer><!--[--><div class="back-button-floating"><div class="floating-ball"><span class="back-icon">←</span><span class="back-text">返回</span></div></div><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"drafts_index.md\":\"Ck7PHTEk\",\"english_index.md\":\"BgnHkeOC\",\"english_常用短语.md\":\"CUFSO8t_\",\"english_语法.md\":\"C7mPbqeq\",\"index.md\":\"SQ4xG-we\",\"investment_index.md\":\"DMgqkC_G\",\"investment_经验教训.md\":\"CJkGG2hc\",\"investment_预案_操作预案.md\":\"Bz_O_G8W\",\"reading-notes_index.md\":\"DqGKQVnO\",\"reading-notes_《大话设计模式》_01-uml.md\":\"YM0DaF-L\",\"reading-notes_《大话设计模式》_02-简单工厂模式.md\":\"CqxM45id\",\"reading-notes_《大话设计模式》_03-策略模式.md\":\"WdfH7nnC\",\"reading-notes_《大话设计模式》_index.md\":\"1uwTb12m\",\"tech-learning_build-blog_index.md\":\"Bi1khc3y\",\"tech-learning_build-blog_使用vuepress搭建博客.md\":\"C3t0pO4o\",\"tech-learning_build-blog_使用vuepress默认主题.md\":\"eA7cIEo2\",\"tech-learning_build-blog_将博客部署到github pages.md\":\"CMUog2WQ\",\"tech-learning_index.md\":\"NqJRs96t\",\"tech-learning_java_index.md\":\"CnOdj_Y3\",\"tech-learning_java_jdk21-virtual-threads-intro.md\":\"CcfjoIWo\",\"tech-learning_java_maven-wrapper.md\":\"Du8RhHd9\",\"tech-learning_practice_index.md\":\"0Ysv7X8O\",\"tech-learning_practice_redis批量删除固定前缀key.md\":\"DlLRQZRF\",\"tech-learning_practice_具体问题列表.md\":\"BcdxE0mS\",\"tech-learning_practice_接口耗时问题排查.md\":\"BGPVcYWR\",\"tech-learning_practice_积分消费日志表数据迁移.md\":\"ZV_VSquq\",\"tech-learning_practice_网络连接相关问题排查.md\":\"lVJaX0Q0\",\"tech-learning_web3_北大肖臻《区块链技术与应用》_readme.md\":\"BRg90L9F\",\"tech-learning_web3_北大肖臻《区块链技术与应用》_笔记01-课程简介.md\":\"fUzJl1Ni\",\"tech-learning_web3_北大肖臻《区块链技术与应用》_笔记02-btc-密码学原理.md\":\"BUiPD7H4\",\"tech-learning_web3_北大肖臻《区块链技术与应用》_笔记03-btc-数据结构.md\":\"CPnbZdkJ\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"zh-CN\",\"dir\":\"ltr\",\"title\":\"kenstant的博客\",\"description\":\"kenstant的博客\",\"base\":\"/blogs/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"nav\":[],\"sidebar\":[],\"aside\":true,\"search\":{\"provider\":\"local\"},\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/kenstant\"}],\"footer\":{\"message\":\"我与我周旋久，宁做我\",\"copyright\":\"Copyright © 2025\"},\"editLink\":false,\"lastUpdatedText\":\"上次更新时间\",\"returnToTopLabel\":\"返回顶部\",\"appearance\":true,\"externalLinkIcon\":true},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":false,\"additionalConfig\":{}}");</script>
    
  </body>
</html>